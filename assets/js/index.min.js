var ctx,mnc;$(function(){function e(){$(".topicPass").html("<li>"+msg[0]+"</li>"),$(".dialogBoxContent").children("nav, div").addClass("hide"),$(".dialogBox-nav, .dialogBox-pkt").removeClass("hide"),$(".dialogBox-nav").children("ul").children("li").removeClass("selected"),$(".dialogBox-nav").children("ul").children("li").eq(0).addClass("selected"),$(".convertBtton").attr("disabled","disabled"),w=null}function t(){$(".dialogBox-nav").find("li").hasClass("nav-img-data")||$(".dialogBox-nav").children("ul").append('<li class="nav-img-data">'+msg[11]+"</li>"),$("#imageData").Jcrop({onSelect:i,onChange:i,bgColor:"white",bgOpacity:.4,aspectRatio:1,minSize:[30,30]},function(){y=this})}function i(e){k.coordinates=e}function a(){$(".dialogBoxContent").children(".panel, .dialogBox-nav").addClass("hide"),$(".dialogBox-pre").removeClass("hide"),$(".dialogBoxHeader").children("h3").text(msg[12])}function n(e){var t=Math.floor(($(window).width()-$(e).width())/2),i=Math.floor(($(window).height()-$(e).height())/2);t=10>=t?10:t,i=10>=i?10:i,$(e).css({top:i,left:t})}function l(){ctx.clearRect(0,0,v.width,v.height),ctx.fillStyle="#3d3d3d",ctx.fillRect(0,0,v.width,20),ctx.fillRect(0,0,20,v.height),ctx.font="10px Verdana",ctx.textAlign="left",ctx.fillStyle="#ccc";for(var e=1;e<v.width/20;e++){var t=1==String(e).length?20*e+6:20*e+4;ctx.fillText(e,t,15,20)}for(var i=0;i<v.height/20;i++){var a=1==String(i).length?6:4,n=0===i?"":i;ctx.fillText(n,a,20*i+14,20)}}function o(e,t){var i=0;if("undefined"==typeof e)var e=0;if("undefined"==typeof t)var t=null;for(var a=0;32>a;a++)for(var n=0;32>n;n++){if(ctx.shadowBlur=0,ctx.shadowColor="rgba(0, 0, 0, 0)",null!=t)var l=b.sheet[e][i].id==t-1?"rgba("+b.sheet[e][i++].rgb+", 1)":"rgba("+b.sheet[e][i++].rgb+", 0.3)";else var l="rgba("+b.sheet[e][i++].rgb+", 1)";ctx.fillStyle=l,ctx.fillRect(20*n+20,20*a+20,20,20)}}function s(){for(var e="rgba(156, 156, 156, 0.8)",t="rgba(0, 0, 0, 0.8)",i=0;i<v.width/20;i++)for(var a=0;a<v.height/20;a++)ctx.beginPath(),ctx.moveTo(20*a,20*i),ctx.lineTo(20*a,v.width),ctx.strokeStyle=e,ctx.stroke(),ctx.beginPath(),ctx.moveTo(20*i,20*a),ctx.lineTo(v.height,20*a),ctx.strokeStyle=e,ctx.stroke();ctx.beginPath(),ctx.moveTo(v.clientHeight/2+10,0),ctx.lineTo(v.clientHeight/2+10,v.clientWidth),ctx.strokeStyle=t,ctx.stroke(),ctx.beginPath(),ctx.moveTo(0,v.clientWidth/2+10),ctx.lineTo(v.clientHeight,v.clientWidth/2+10),ctx.strokeStyle=t,ctx.stroke()}function c(e){var t=0;if("undefined"==typeof e)var e=0;for(var i=0;32>i;i++)for(var a=0;32>a;a++){if(ctx.font="bold 10px Verdana",ctx.textAlign="left",ctx.fillStyle="rgba(255, 255, 255, 1)",ctx.shadowBlur=1,ctx.shadowColor="rgba(0, 0, 0, 1)",0!=b.sheet[e][t].num)var n=b.sheet[e][t++].num;else{var n="";t++}var l=1==String(n).length?20*a+6:20*a+3;ctx.fillText(n,l+20,20*i+20+14,20)}}function d(){mnc.clearRect(0,0,C.width,C.height)}function r(){B=new Image,B.src="data:image/jpeg;base64,"+b.thumbnail,B.onload=function(){P.ix=(C.clientWidth-B.width)/2,P.iy=(C.clientHeight-B.height)/2,mnc.imageSmoothingEnabled=!1,mnc.mozImageSmoothingEnabled=!1,mnc.webkitImageSmoothingEnabled=!1,mnc.drawImage(B,P.ix,P.iy,B.width,B.height),h(),$(".miniMapContainer > *").hasClass("miniMapOptions")||($(".miniMapContainer").append('<ul class="miniMapOptions clearfix"></ul>'),$(".miniMapContainer").children("ul").append('<li><input type="button" value="'+tool[9]+'" class="submit c-m-c"></li>'))}}function h(){for(var e=0;e<b.size.x;e++)for(var t=0;t<b.size.y;t++)mnc.strokeRect(P.ix+e*(B.width/b.size.x),P.iy+t*(B.height/b.size.y),B.width/b.size.x,B.height/b.size.y)}function g(e){var t=e.target.getBoundingClientRect();if(mx=e.clientX-t.left,my=e.clientY-t.top,P.ix<=mx&&P.iy<=my&&P.ix+B.width>=mx&&P.iy+B.height>=my)for(var i=B.width/b.size.x,a=B.height/b.size.y,n=0,d=0;d<b.size.x;d++)for(var r=0;r<b.size.y;r++){if(P.ix+d*i<=mx&&P.iy+r*a<=my&&P.ix+d*i+i>=mx&&P.iy+r*a+a>=my){l(),o(n,I),$(".c-d-g").hasClass("on")&&s(),$(".c-d-n").hasClass("on")&&c(n),T=n;break}n++}}function p(){$.ajax({type:"GET",url:"data/palette.html",dataType:"html",success:function(e){S=e,$(".palette-all").html(e),$(".palette-ext").empty();var t=0;$.each(b.palette.id,function(e,i){var a=e,n=i;$(".palette-block").children("li").each(function(){$(this).data("id")==a&&($(this).html("<span>"+ ++t+"</span>"),$(".palette-ext").append('<span style="background-color: #'+n+';" data-id="'+a+'">'+t+"</span>"))})}),$(".optionMenu").find("input").hasClass("c-p-c")||$(".optionMenu").append('<li><input type="button" class="submit c-p-c" value="'+msg[13]+'"></li>')}})}function m(e){var t=document.getElementById(e),i=t.toDataURL(),a=f(i);u(a,"design.png")}function u(e,t){var i=window.URL||window.webkitURL,a=i.createObjectURL(e),n=document.createEvent("MouseEvents");n.initMouseEvent("click",!0,!1,window,0,0,0,0,0,!1,!1,!1,!1,0,null);var l=document.createElementNS("http://www.w3.org/1999/xhtml","a");l.href=a,l.download=t,l.dispatchEvent(n)}function f(e){var t,i=e.split(","),a=atob(i[1]),n=i[0].split(":")[1].split(";")[0],l=new ArrayBuffer(a.length),o=new Uint8Array(l);for(t=0;t<a.length;t++)o[t]=a.charCodeAt(t);var s=new Blob([o],{type:n});return s}function x(){$("#wrapper").children("header").after(""),$(document).on("click","#tobimy_info .close",function(){$("#tobimy_info").fadeOut(250)})}var v=document.getElementById("conversion");if(!v||!v.getContext)return!1;v.width=v.height=660*window.devicePixelRatio,ctx=v.getContext("2d"),ctx.scale(window.devicePixelRatio,window.devicePixelRatio);var C=document.getElementById("miniMap");if(C.addEventListener("mousedown",g,!1),!C||!C.getContext)return!1;C.width=280*window.devicePixelRatio,C.height=270*window.devicePixelRatio,mnc=C.getContext("2d"),mnc.scale(window.devicePixelRatio,window.devicePixelRatio);var b,w,y,k,B,S,z,T,I,R={minimap:!0},k={size:{width:32,height:32},maxColor:15,autoSize:0,palette:null,coordinates:null},P={};localStorage.getItem("design")?(b=JSON.parse(localStorage.getItem("design")),$("#convert").css("visibility","visible"),l(),o(),s(),c(),d(),r(),p()):$("#dialogBox").fadeIn(),2!=$.cookie("tobimy_info")&&($.cookie("tobimy_info",null,{expires:-1,path:"/"}),$.cookie("tobimy_info",2,{expires:730,path:"/"}),x()),$("#language").change(function(){$.cookie("language",$("option:selected",this).val(),{expires:1825,path:"/"}),location.reload()}),$("img").lazyload({effect:"fadeIn",effectspeed:1e3}),new Dropzone(".stage",{url:"data/upload-status.json",paramName:"file",previewsContainer:".picker-area",parallelUploads:1,maxThumbnailFilesize:5,maxFilesize:5,createImageThumbnails:!0,init:function(){this.on("addedfile",function(e){$(".dialogBox-pre").addClass("loader"),$(".picker-area").empty(),a()}),this.on("success",function(i,a){switch(w=$.parseJSON(a),w.status){case 0:$(".picker-area").empty(),$(".topicPass").html("<li>"+msg[0]+"</li><li>"+i.name+"</li>"),$(".picker-area").html('<img id="imageData" src="data:'+w.type+";base64,"+w.data+'">'),t();break;case 1:case 2:e(),alert(msg[1]);break;case 3:e(),alert(msg[2]);break;case 4:e(),alert(msg[3]);break;case 6:case 7:case 8:e(),alert(msg[4]);break;case 100:e(),alert(msg[5]);break;default:e(),alert("Undefined Error")}$(".dialogBox-pre").removeClass("loader")}),this.on("error",function(t){e(),alert(data)})}}),$(".obtain-img-button").click(function(){$(".obtain-img-url").val().length>=12&&($(".dialogBox-pre").addClass("loader"),$(".picker-area").empty(),a(),$.ajax({type:"POST",url:"data/obtain-img",dataType:"json",data:{url:$(".obtain-img-url").val()}}).done(function(i){w=i,0==w.status?($(".topicPass").append("<li>"+$(".obtain-img-url").val()+"</li>"),$(".picker-area").html('<img id="imageData" src="data:'+i.type+";base64,"+i.data+'">'),t(),$(".dialogBox-pre").removeClass("loader")):1==w.status&&(e(),alert(msg[6]))}).fail(function(t,i,a){e(),alert(a)}))}),$(".dialogBoxContent").children("div, nav").css("minHeight",$("#dialogBox").height()-$(".dialogBoxHeader").outerHeight()),$(".dialogBox-pre").css("minHeight",$("#dialogBox").height()-($(".dialogBoxHeader").outerHeight(!0)+$(".topicPass").outerHeight(!0)+$(".picker-footer").outerHeight(!0))),n("#dialogBox"),$(window).resize(function(){n("#dialogBox")}),$(".closeButton").click(function(){$("#dialogBox").fadeOut()}),$(".dialogBox-changer").click(function(e){$("#dialogBox").fadeToggle(),e.stopPropagation()}),$(".delete").click(function(e){$("#dialogBox").fadeIn(),$("#convert").css("visibility","hidden"),localStorage.removeItem("design"),e.stopPropagation()}),$(".about").click(function(){$("html, body").scrollTop(0),$("#about").isVisible()?($("#content").children("div").fadeOut(100),$("#convert").fadeIn(100),localStorage.getItem("design")||$("#dialogBox").fadeIn()):($("#content").children("div").fadeOut(100),$("#about").fadeIn(100))}),$(".dialogBox-nav").children("ul").children("li").click(function(){var e=$(".dialogBox-nav").children("ul").children("li").index(this);$(".dialogBox-nav").children("ul").children("li").removeClass("selected"),$(this).addClass("selected"),$(".dialogBoxContent").children(".panel").addClass("hide").eq(e).removeClass("hide")}),$(document).on("click",".nav-img-data",function(){a()}),$("h1").children("a").hover(function(){$("h1").append('<span style="background-color: #f33;"></span><span style="background-color: #39f;"></span><span style="background-color: #0ac90a;"></span>'),$("h1").children("span").eq(0).animate({top:"42px",right:"40px"},{duration:100,easing:"linear"}),$("h1").children("span").eq(1).animate({top:"43px",right:"26px"},{duration:100,easing:"linear"}),$("h1").children("span").eq(2).animate({top:"41px",right:"33px"},{duration:100,easing:"linear"})},function(){$("h1").children("span").remove()}),$(".imageSet").click(function(){null!=k.coordinates?($(".convertBtton").removeAttr("disabled"),$(".dialogBoxContent").children("nav, div").addClass("hide"),$(".dialogBox-nav, .dialogBox-opt").removeClass("hide"),$(".dialogBox-nav").children("ul").children("li").removeClass("selected"),$(".dialogBox-nav").children("ul").children("li").eq(2).addClass("selected")):alert(msg[7])}),$(".autoSize").click(function(){k.autoSize=1,$(".convertBtton").removeAttr("disabled"),$(".dialogBoxContent").children("nav, div").addClass("hide"),$(".dialogBox-nav, .dialogBox-opt").removeClass("hide"),$(".dialogBox-nav").children("ul").children("li").removeClass("selected"),$(".dialogBox-nav").children("ul").children("li").eq(2).addClass("selected")}),$(".convertBtton").click(function(){null==w?console.log(msg[8]):1==$(".convertBtton").is(":disabled")?alert(msg[9]):0!=w.status?console.log("error"):($("#content").addClass("loader").children("div").fadeOut(),$("#convert").fadeIn(),$("#dialogBox").fadeOut(),localStorage.getItem("design")&&($("#convert").css("visibility","hidden"),l(),d(),$(".palette-all").html(S),$(".palette-ext").empty()),$.ajax({type:"POST",url:"data/convert",dataType:"json",data:{id:w.id,token:w.token,accessToken:w.accessToken,myDesign:$.param(k)}}).done(function(e){$(".nav-img-data").remove(),$(".obtain-img-url").val(""),$(".topicPass").html("<li>"+msg[0]+"</li>"),$("#convert").css("visibility","visible").fadeIn(),$("#content").removeClass("loader"),w=null,b=e,localStorage.setItem("design",JSON.stringify(e)),l(),o(),s(),c(),d(),r(),p()}).fail(function(e,t,i){$("#content").removeClass("loader"),$("#dialogBox").fadeIn(),alert(i)}))}),$(".option").find("input:checkbox").click(function(){this.checked?$(this).next().addClass("checked"):$(this).next().removeClass("checked")}),$(".selectAll").click(function(){y.animateTo(getRandom())}),$(".pltSelect").click(function(){$(this).is(":checked")?($(".pltSelection").removeClass("hide"),$(".sizeSelection").hasClass("hide")||$(".sizeSelection").addClass("hide"),$(".paletteSelectContainer").children("div").hasClass("plt")||$.ajax({type:"GET",url:"data/palette.htm",dataType:"html",success:function(e){$(".paletteSelectContainer").html(e),z=0,$(".paletteOption").children(".submit-a").click(function(){var e=$(".paletteOption").children("input:button").index(this),t=$(".paletteSelectContainer").children(".plt").length-1;if(0==e)var i=--z<0?z=t:z;else var i=++z>t?z=0:z;k.palette=i,$(".paletteSelectContainer").children(".plt").hide(),$(".paletteSelectContainer").children(".plt").eq(i).show()})}})):($(".pltSelection").addClass("hide"),$(".paletteBox").find(".plt").hide(),$(".paletteBox").find(".plt").eq(0).show(),z=0,k.palette=null)}),$(".select-size").change(function(){if("randomSize"==$("option:selected",this).data("change")){if($(".sizeSelection").removeClass("hide"),$(".pltSelection").hasClass("hide")||$(".pltSelection").addClass("hide"),!$("#designBox").children().hasClass("design-sheet"))for(var e=0;81>e;e++)$("#designBox").append('<div class="design-sheet"></div>')}else{$(".sizeSelection").addClass("hide");var t=$("option:selected",this).val().split(",");k.size.width=t[0],k.size.height=t[1],"undefined"!=typeof y&&y.setOptions({aspectRatio:k.size.width/k.size.height})}}),$(".select-max-color").change(function(){k.maxColor=$("option:selected",this).text()}),$(".sheet").draggable({grid:[26,26],opacity:.9,containment:"#designBox"}).resizable({grid:[26,26],minHeight:25,minWidth:25,handles:"all",containment:"#designBox",stop:function(e,t){if(32*(t.size.width%25+1)/32*(32*(t.size.height%25+1)/32)<=9){var i=32*(t.size.width%25+1)/32,a=32*(t.size.height%25+1)/32;k.size.width=32*i,k.size.height=32*a,"undefined"!=typeof y&&y.setOptions({aspectRatio:i/a}),$(".sheet").css({backgroundColor:"rgba(0, 0, 0, 0.8)"})}else $(".sheet").css({backgroundColor:"rgba(255, 0, 0, 0.8)"})}}),$(".c-d-n").click(function(){null!=b?$(this).hasClass("on")?($(this).removeClass("on"),l(),o(T,I),$(".c-d-g").hasClass("on")&&s()):($(this).addClass("on"),l(),o(T,I),$(".c-d-g").hasClass("on")&&s(),c(T)):alert(msg[10])}),$(".c-d-g").click(function(){null!=b&&($(this).hasClass("on")?($(this).removeClass("on"),l(),o(T,I),$(".c-d-n").hasClass("on")&&c(T)):($(this).addClass("on"),l(),o(T,I),s(),$(".c-d-n").hasClass("on")&&c(T)))}),$(document).on("click",".c-p-c",function(){$(".palette-all").hasClass("hide")?($(".palette-ext").addClass("hide"),$(".palette-all").removeClass("hide")):($(".palette-all").addClass("hide"),$(".palette-ext").removeClass("hide"))}),$(document).on("click",".c-m-c",function(){R.minimap?(R.minimap=!1,mnc.clearRect(0,0,C.width,C.height),mnc.drawImage(B,P.ix,P.iy,B.width,B.height)):(R.minimap=!0,mnc.clearRect(0,0,C.width,C.height),mnc.drawImage(B,P.ix,P.iy,B.width,B.height),h())}),$(document).on("click",".palette-block > li > span",function(){l(),$(this).parent("li").hasClass("active")?($(".paletteContainer *").removeClass("active"),I=null,o(T),$(".c-d-g").hasClass("on")&&s(),$(".c-d-n").hasClass("on")&&c(T)):($(".palette-block").children("li").removeClass("active"),$(this).parent("li").addClass("active"),I=$(this).parent("li").data("id"),o(T,$(this).parent("li").data("id")),$(".c-d-g").hasClass("on")&&s(),$(".c-d-n").hasClass("on")&&c(T))}),$(document).on("click",".palette-ext > span",function(){l(),$(this).hasClass("active")?($(".paletteContainer *").removeClass("active"),I=null,o(T),$(".c-d-g").hasClass("on")&&s(),$(".c-d-n").hasClass("on")&&c(T)):($(".palette-ext").children("span").removeClass("active"),$(this).addClass("active"),I=$(this).data("id"),o(T,$(this).data("id")),$(".c-d-g").hasClass("on")&&s(),$(".c-d-n").hasClass("on")&&c(T))}),$(document).on("click",".img-dl",function(){m("conversion")})}),$.fn.isVisible=function(){return $.expr.filters.visible(this[0])};